name: Create & deploy Storefront infrastructure

on:
  push:
    branches: [ "test" ]

permissions:
  id-token: write
  contents: read

jobs:
  # The following jobs are currently commented out.
  # Uncomment them and adjust 'needs:' dependencies as you build out your pipeline.

  # reset-aws:
  #   name: Reset AWS objects
  #   uses: ./.github/workflows/pipeline-drop-aws.yml
  #   secrets: inherit

  # create-golden-image:
  #   name: Create base image
  #   needs: reset-aws # Ensure 'reset-aws' is uncommented if this dependency is active
  #   runs-on: ubuntu-latest
  #   environment: Prod
  #   outputs:
  #     ami_id: ${{ steps.packerbuild.outputs.ami_id }}

  #   steps:
  #   - name: Checkout
  #     uses: actions/checkout@v4

  #   - name: Configure AWS credentials
  #     uses: aws-actions/configure-aws-credentials@v2
  #     with:
  #       role-to-assume: ${{ secrets.AWS_PIPELINE_ROLE }}
  #       aws-region: ${{ vars.AWS_REGION }}

  #   - name: Install Packer
  #     uses: hashicorp/setup-packer@v2
  #     with:
  #       version: 'latest'

  #   - name: Initialize Packer
  #     run: packer init image-base.pkr.hcl

  #   - name: Validate Packer template
  #     run: packer validate -var "aws_region=${{ vars.AWS_REGION }}" image-base.pkr.hcl

  #   - name: Build and customize base AMI
  #     id: packerbuild
  #     run: |
  #       echo "Running Packer build..."
  #       packer build -var "aws_region=${{ vars.AWS_REGION }}" -machine-readable image-base.pkr.hcl | tee packer_output.log

  #       echo "Extracting AMI ID from output..."
  #       AMI_ID=$(awk -F, '/artifact,0,id/ {print $6}' packer_output.log | cut -d ':' -f2)

  #       # share ami with dev admin user
  #       aws ec2 modify-image-attribute \
  #         --image-id "$AMI_ID" \
  #         --launch-permission "Add=[{UserId=${{ secrets.AWS_USER_DEVADMIN }}}]"

  #       echo "AMI ID: $AMI_ID"
  #       echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT

  test-base-image:
    name: Test base image
    # Uncomment the 'needs' line below and remove the hardcoded AMI ID
    # once 'create-golden-image' job is active and producing output.
    # needs: create-golden-image
    runs-on: ubuntu-latest
    environment: Prod
    outputs:
      instance_id: ${{ steps.ec2_launch.outputs.instance_id }}
      public_ip: ${{ steps.ec2_launch.outputs.public_ip }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_PIPELINE_ROLE }}
        aws-region: ${{ vars.AWS_REGION }}

    - name: Launch EC2 instance from AMI
      id: ec2_launch
      run: |
        set -e
        TIMESTAMP=$(date +%s)
        NAME="ec2-base-zero-storefront-${TIMESTAMP}"
        INSTANCE_INFO=$(aws ec2 run-instances \
          --image-id "ami-0caf48451cb6750de" \
          --count 1 \
          --instance-type t2.micro \
          --key-name ${{ secrets.AWS_KEYNAME }} \
          --subnet-id ${{ secrets.AWS_SUBNET }} \
          --security-group-ids ${{ secrets.AWS_SECURITYGROUP }} \
          --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=$NAME},{Key=Role,Value=Base}]" \
          --query 'Instances[0].[InstanceId,PublicIpAddress]' \
          --output text)
        instance_id=$(echo "$INSTANCE_INFO" | awk '{print $1}')
        public_ip=$(echo "$INSTANCE_INFO" | awk '{print $2}')
        echo "instance_id=$instance_id"
        echo "public_ip=$public_ip"

    - name: Debug public IP and Instance ID
      run: |
        # These outputs are from the *current* job's steps, not from 'needs'.
        # Remove 'needs.test-base-image' prefix.
        echo "Public IP is: ${{ steps.ec2_launch.outputs.public_ip }}"
        echo "Instance ID is: ${{ steps.ec2_launch.outputs.instance_id }}"


    - name: Terminate EC2 instance
      if: always() # Ensures termination even if previous steps fail
      run: |
        aws ec2 terminate-instances --instance-ids ${{ steps.ec2_launch.outputs.instance_id }}
